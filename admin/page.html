<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YPP Admin Panel</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="/css/style.css">
    
    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/e4704dcbbd.js" crossorigin="anonymous"></script>

    <!-- Style -->
    <style>
        :root{
            --mxw: 1440px;
            --gap: 16px;
            --box-color: #d9d9d9;
            --line-color: #ececec;
        }
        body{
            min-height: 100dvh;
        }
        p, span{margin-bottom: 0; color: #000;}
        /* =========== */

        .main-container{ max-width: var(--mxw); margin: 0 auto; padding: 20px; box-sizing: border-box;}
        
        /* =========== */

        .links{position: fixed;bottom: 25px;left: 25px;}
        .links a img{
            width: 2.25rem;
            box-shadow: 0 1px 5px rgb(0 0 0 / 56%);
            border-radius: 7px;
        }
        .links a:hover img{
            transform: scale(1.05);
            transition: all 0.3s ease;
        }

        /* =========== */
        /* =========== Clock Styles =========== */
        header{width: 100%;display: flex; justify-content: space-between;padding: 10px 0;}
        .clock-widget {font-size: 1.1rem;}
        /* =========== */
        .page-top{
            /* border-bottom: 1px solid var(--line-color); */
            padding: 1rem 0 1rem 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            flex-direction: column;
            gap: 2rem;
        }
        .page-title{font-size: 2.5rem;}
        .page-info{display: flex; flex-direction: column; gap: 4px; text-align: right;font-size: .8rem;}
        .page-count{font-size: 1.8rem;}
        .page-count i{font-size: 1rem; margin-bottom: 1rem;}

        /* =========== Data List Styles =========== */
        /* .data-container {margin-top: 2rem;} */
        
        .data-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .toolbar-left,
        .toolbar-right {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            margin: 0 0.125rem;
        }

        
        /* =========== Table Styles =========== */
        .data-table-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 600px; /* 테이블 최대 높이 설정 */
            overflow-y: auto; /* 세로 스크롤 활성화 */
        }
        .data-table-container::-webkit-scrollbar { 
            width: 4px;
        }
        .data-table-container::-webkit-scrollbar-thumb { 
            background-color: #C6C6C6;
            border-radius: 3px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: .9rem;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10; /* 헤더가 위에 오도록 설정 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* 헤더 하단에 그림자 추가 */
        }
        
        .data-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }
        
        .data-table .col-checkbox { width: 40px; }
        .data-table .col-id { width: 80px; }
        .data-table .col-number { width: 80px; }
        .data-table .col-status,
        .data-table .col-actions,
        .data-table .col-date { width: auto; text-align: center;}
        .data-table .col-checkbox { text-align: center;}

        /* =========== 그룹핑 스타일 =========== */
        .grouped-cell {
            border-left: 3px solid #007bff;
            padding-left: 12px !important;
        }
        
        .group-header {
            font-weight: 500;
            color: #495057;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .group-icon {
            color: #007bff;
        }
        
        .group-item {
            display: block;
            padding: 2px 0;
            color: #6c757d;
        }

        /* =========== Modal Styles =========== */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 0;
            border: none;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: relative;
        }
        
        .modal-header {
            padding: 20px 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .modal-body {
            padding: 0 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .group-delete-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .group-delete-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f9f9f9;
        }
        
        .group-delete-item:hover {
            background: #f0f0f0;
        }
        
        .group-delete-item input[type="checkbox"] {
            margin: 0;
        }
        
        .group-delete-item-content {
            flex: 1;
            font-size: 0.9rem;
        }
        
        .select-all-wrapper {
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: #f3f5f7;
            border: 1px solid #f3f5f7;
        }
        
        .btn-primary:hover {
            background-color: #e2e6ea;
        }
        
        .btn-secondary {
            background-color: #f3f5f7;
            border: 1px solid #f3f5f7;
        }
        
        .btn-secondary:hover {
            background-color: #e2e6ea;
            border-color: #d3d9db;
        }

        /* =========== Status Styles =========== */
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        /* .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; } */
        
        /* =========== Responsive =========== */
        @media (max-width: 768px) {
            .toolbar-left { flex-direction: column; gap: 0.5rem; }
        }
        
        @media (min-width: 769px) {
        }
    </style>
</head>
<body>
    <section class="links">
        <a href="/" target="_blank"><img src="/assets/images/favicon/apple-icon-76x76.png" alt="" srcset=""></a>
    </section>
    <div class="main-container">
        <header>
            <a href="/admin/" class="btn-home">
                <i class="fas fa-home"></i>
            </a>
            <div class="clock-widget">
                <span class="clock-date" id="clock-date"></span>
                <span class="clock-time">
                    <span id="clock-hours"></span>:<span id="clock-minutes"></span><span class="clock-period" id="clock-period"></span>
                </span>
            </div>
        </header>
        <main>
            <div class="page-top">
                <div class="page-title"></div>
                <div class="page-info">
                    <p class="page-count">
                        <i class="fas fa-spinner fa-spin"></i>
                    </p>
                    <p class="page-location">홈 > </p>
                    <p class="page-descripation">페이지 디스크립션</p>
                </div>
            </div>
            <div class="page-mid">
                <!-- 데이터 관리 컨테이너 -->
                <div class="data-container">

                    <!-- 툴바 -->
                    <div class="data-toolbar">
                        <div class="toolbar-left">
                            <button class="btn btn-secondary btn-sm" id="btn-sort-toggle" title="정렬 순서 변경">
                                <i class="fas fa-sort-amount-down" id="sort-icon"></i> 최신순
                            </button>
                        </div>
                        <div class="toolbar-right">
                            <button class="btn btn-primary" id="btn-add">
                                <i class="fas fa-plus"></i> 새로 추가
                            </button>
                            <button class="btn btn-danger" id="btn-delete-selected" disabled>
                                <i class="fas fa-trash"></i> 선택 삭제
                            </button>
                        </div>
                    </div>
                    
                    <!-- 테이블 (데스크톱) -->
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <!-- <th class="col-checkbox">
                                        <input type="checkbox" id="select-all">
                                    </th>
                                    <th class="col-id">ID</th>
                                    <th>제목</th>
                                    <th class="col-date">날짜</th>
                                    <th class="col-status">상태</th>
                                    <th class="col-actions">액션</th> -->
                                </tr>
                            </thead>
                            <tbody id="data-table-body">
                                <!-- 동적 생성 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 로딩 표시 -->
                    <div id="loading-indicator" style="text-align: center; padding: 20dvh 2rem;">
                        <i class="fas fa-spinner fa-spin"></i> 데이터를 불러오는 중...
                    </div>

                    <!-- 빈 상태 표시 -->
                    <div id="empty-state" style="display: none; text-align: center; padding: 3rem; color: #666;">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>등록된 데이터가 없습니다.</p>
                        <button class="btn btn-primary" onclick="document.getElementById('btn-add').click()">
                            첫 번째 항목 추가하기
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-content"></div>
            <div class="modal-add"></div>
        </main>
    </div>

    <!-- 그룹 삭제 모달 -->
    <div id="groupDeleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">그룹 항목 선택 삭제</h2>
                <button class="modal-close" onclick="closeGroupDeleteModal()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="select-all-wrapper">
                    <label>
                        <input type="checkbox" id="selectAllGroupItems"> 전체 선택
                    </label>
                </div>
                <ul id="groupDeleteList" class="group-delete-list">
                    <!-- 그룹 아이템들이 동적으로 추가됩니다 -->
                </ul>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGroupDeleteModal()">취소</button>
                <button class="btn btn-danger" onclick="deleteSelectedGroupItems()">선택 삭제</button>
            </div>
        </div>
    </div>
</body>
</html>

<script>
// 페이지 로드 시 실행
document.addEventListener('DOMContentLoaded', () => {
    const clock = new Clock(); // 시계 인스턴스 생성
    clock.start(); // 시계 시작
    const pageManager = new PageManager(); // 페이지 매니저 생성
    window.pageManagerInstance = pageManager; // 전역 변수로 저장
    pageManager.init(); // 페이지 초기화
});

// 시계 클래스
class Clock {
    constructor() {
        this.intervalId = null;
    }
    
    start() {
        this.updateClock(); // 즉시 시계 업데이트
        this.intervalId = setInterval(() => this.updateClock(), 1000); // 1초마다 업데이트
    }
    
    stop() {
        if (this.intervalId) {
            clearInterval(this.intervalId);
            this.intervalId = null;
        }
    }
    
    updateClock() {
        const now = new Date();
        
        // 시간 계산 (12시간 형식)
        let hours = now.getHours();
        const minutes = now.getMinutes();
        const period = hours >= 12 ? 'PM' : 'AM';
        
        // 12시간 형식으로 변환
        if (hours > 12) {
            hours = hours - 12;
        } else if (hours === 0) {
            hours = 12;
        }
        
        // 날짜 계산
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const date = now.getDate();
        
        // DOM 업데이트 (한자리수도 그대로 표시)
        document.getElementById('clock-hours').textContent = hours.toString();
        document.getElementById('clock-minutes').textContent = minutes.toString().padStart(2, '0'); // 분은 항상 2자리
        document.getElementById('clock-period').textContent = period;
        document.getElementById('clock-date').textContent = `${year}년 ${month}월 ${date}일`;
    }
}
// ===========================================================================================
// 날짜/시간 유틸리티 함수들
// ===========================================================================================

/**
 * datetime 문자열을 날짜와 시간으로 분리하는 함수
 * @param {string} datetime - "YYYY-MM-DD HH:mm:ss" 또는 "YYYY-MM-DD" 형식의 문자열
 * @returns {Object} {date: "YYYY-MM-DD", time: "HH:mm:ss", dateOnly: "YYYY-MM-DD", timeOnly: "HH:mm"}
 */
function parseDatetime(datetime) {
    if (!datetime || typeof datetime !== 'string') {
        return { date: '-', time: '-', dateOnly: '-', timeOnly: '-' };
    }
    
    try {
        const parts = datetime.split(' ');
        if (parts.length >= 2) {
            // 날짜와 시간이 모두 있는 경우
            const datePart = parts[0]; // YYYY-MM-DD
            const timePart = parts[1]; // HH:mm:ss
            const timeOnly = timePart.substring(0, 5); // HH:mm만 추출
            
            return {
                date: datePart,
                time: timePart,
                dateOnly: datePart,
                timeOnly: timeOnly
            };
        } else if (parts.length === 1 && datetime.includes('-')) {
            // 날짜만 있는 경우 (YYYY-MM-DD)
            const datePart = parts[0];
            return {
                date: datePart,
                time: '-',
                dateOnly: datePart,
                timeOnly: '-' // 시간이 없으면 "-" 대신 빈 문자열로 처리
            };
        }
        
        return { date: datetime, time: '-', dateOnly: datetime, timeOnly: '-' };
        
    } catch (error) {
        console.error('parseDatetime 에러:', error);
        return { date: datetime, time: '-', dateOnly: datetime, timeOnly: '-' };
    }
}

/**
 * 날짜를 한국어 형식으로 포맷팅
 * @param {string} dateStr - "YYYY-MM-DD" 형식
 * @returns {string} "YYYY년 MM월 DD일" 형식
 */
function formatKoreanDate(dateStr) {
    if (!dateStr || dateStr === '-') return '-';
    
    try {
        const parts = dateStr.split('-');
        if (parts.length === 3) {
            return `${parts[0]}년 ${parseInt(parts[1])}월 ${parseInt(parts[2])}일`;
        }
        return dateStr;
    } catch (error) {
        return dateStr;
    }
}

/**
 * 시간을 12시간 형식으로 변환
 * @param {string} timeStr - "HH:mm:ss" 또는 "HH:mm" 형식
 * @returns {string} "오전/오후 HH:mm" 형식
 */
function formatKoreanTime(timeStr) {
    if (!timeStr || timeStr === '-') return '-';
    
    try {
        const timeParts = timeStr.split(':');
        if (timeParts.length >= 2) {
            let hour = parseInt(timeParts[0]);
            const minute = timeParts[1];
            const period = hour >= 12 ? '오후' : '오전';
            
            if (hour > 12) hour -= 12;
            if (hour === 0) hour = 12;
            
            return `${period} ${hour}:${minute}`;
        }
        return timeStr;
    } catch (error) {
        return timeStr;
    }
}

// ===========================================================================================
// ===========================================================================================
// 페이지 관리 클래스
class PageManager {
    constructor() {
        // Google Apps Script 웹앱 URL (index.html과 동일)
        this.DASHBOARD_APPS_SCRIPT_ID = 'AKfycbx9Eep2rpGs6kDurpw8cs93A-RZjMoa99GggIuf9Q4tDmDB8ZScSJf7FAqjmJGwpmlz';
        this.appsScriptUrl = `https://script.google.com/macros/s/${this.DASHBOARD_APPS_SCRIPT_ID}/exec`;
        this.pageConfigs = this.initPageConfigs();
        this.isDescending = true; // 기본값: 최신순 (내림차순)
        this.currentData = null; // 현재 로드된 데이터 저장
        this.currentConfig = null; // 현재 설정 저장
    }
    
    // 페이지별 설정 데이터 초기화
    initPageConfigs() {
        return {
            '팝업': {
                title: '팝업',
                description: '홈페이지 팝업 관리',
                location: '홈 > 팝업',
                apiSheet: 'SHEET_DASHBOARD', // 임시
                dataKey: 'popup'
            },
            '인허가': {
                title: '갤러리 인허가',
                description: '인허가 관련 갤러리 이미지 관리',
                location: '갤러리 > 인허가',
                apiSheet: 'SHEET_GAL_A',
                dataKey: 'galA'
            },
            '유자격': {
                title: '갤러리 유자격',
                description: '유자격 관련 갤러리 이미지 관리',
                location: '갤러리 > 유자격',
                apiSheet: 'SHEET_GAL_B',
                dataKey: 'galB'
            },
            '인사이드': {
                title: '갤러리 인사이드',
                description: '인사이드 관련 갤러리 컨텐츠 관리',
                location: '갤러리 > 인사이드',
                apiSheet: 'SHEET_GAL_C',
                dataKey: 'galC'
            },
            '아카데미': {
                title: '갤러리 아카데미',
                description: '아카데미 관련 갤러리 컨텐츠 관리',
                location: '갤러리 > 아카데미',
                apiSheet: 'SHEET_GAL_F',
                dataKey: 'galD'
            },
            '보도자료': {
                title: '보도자료',
                description: '언론 보도자료 및 뉴스 관리',
                location: '게시판 > 보도자료',
                apiSheet: 'SHEET_BOARD_NEWS',
                dataKey: 'boardNews'
            },
            'PSAC': {
                title: 'PSAC 신청',
                description: 'PSAC 교육과정 신청서 관리',
                location: '아카데미 > PSAC',
                apiSheet: 'SHEET_APPLY_P',
                dataKey: 'applyPSAC'
            },
            'RelaySchool': {
                title: 'Relay School 신청',
                description: 'Relay School 교육과정 신청서 관리',
                location: '아카데미 > Relay School',
                apiSheet: 'SHEET_APPLY_R',
                dataKey: 'applyRelay'
            },
            '자주묻는질문': {
                title: '자주 묻는 질문',
                description: 'FAQ 관리',
                location: '고객센터 > 자주 묻는 질문',
                apiSheet: 'SHEET_DASHBOARD', // 임시
                dataKey: 'faq'
            },
            '고객문의': {
                title: '고객문의',
                description: '고객 문의사항 관리',
                location: '고객센터 > 고객문의',
                apiSheet: 'SHEET_HELP_KR',
                dataKey: 'helpKR'
            },
            '부패및윤리신고': {
                title: '부패 및 윤리 신고',
                description: '부패신고 및 윤리위반 신고 관리',
                location: '고객센터 > 부패 및 윤리 신고',
                apiSheet: 'SHEET_REPORT',
                dataKey: 'report'
            }
        };
    }
    
    // 페이지 초기화
    async init() {
        const urlParams = new URLSearchParams(window.location.search);
        const pageParam = urlParams.get('page');
        
        if (!pageParam) {
            this.showError('페이지 파라미터가 없습니다.');
            return;
        }
        
        const config = this.pageConfigs[pageParam];
        if (!config) {
            this.showError(`알 수 없는 페이지: ${pageParam}`);
            return;
        }
        
        // 페이지 정보 업데이트
        this.updatePageInfo(config);
        
        // 데이터 카운트 로드
        await this.loadPageCount(config);
        
        // 실제 데이터 로드 및 테이블 렌더링
        await this.loadPageData(config);
        
        // 정렬 토글 버튼 이벤트 설정
        this.setupSortToggle();
        
        // 삭제 버튼 이벤트 설정
        this.setupDeleteButtons();
    }
    
    // 페이지 정보 업데이트
    updatePageInfo(config) {
        document.querySelector('.page-title').textContent = config.title;
        document.querySelector('.page-descripation').textContent = config.description;
        document.querySelector('.page-location').textContent = config.location;
        
        // 페이지 타이틀도 업데이트
        document.title = `YPP Admin - ${config.title}`;
    }
    
    // 페이지별 데이터 카운트 로드
    async loadPageCount(config) {
        try {
            // console.log(`${config.title} 데이터 카운트 로드 중...`);
            
            // 대시보드에서 카운트 정보 가져오기 (index.html과 동일한 URL 형식)
            const url = `${this.appsScriptUrl}?sheet=SHEET_DASHBOARD&action=getData`;
            const response = await fetch(url);
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message);
            }
            
            // console.log('=== 디버깅 정보 ===');
            // console.log('config:', config);
            // console.log('config.dataKey:', config.dataKey);
            // console.log('result.data:', result.data);
            // console.log('result.data[config.dataKey]:', result.data[config.dataKey]);
            
            const count = result.data[config.dataKey] || 0;
            document.querySelector('.page-count').textContent = `${count}건`;
            
            // console.log(`${config.title}: ${count}건`);
            // console.log('=== 디버깅 끝 ===');
            
        } catch (error) {
            console.error('데이터 카운트 로드 실패:', error);
            document.querySelector('.page-count').textContent = '0건';
        }
    }
    
    // 에러 표시
    showError(message) {
        document.querySelector('.page-title').textContent = '오류';
        document.querySelector('.page-descripation').textContent = message;
        document.querySelector('.page-location').textContent = '오류 페이지';
        document.querySelector('.page-count').textContent = '0건';
        
        console.error('PageManager 오류:', message);
    }
    
    // 페이지 데이터 로드
    async loadPageData(config) {
        try {
            this.showLoading(true);
            // console.log(`${config.title} 데이터 로드 중...`);
            
            // API에서 실제 데이터 가져오기 (index.html과 동일한 URL 형식)
            const url = `${this.appsScriptUrl}?sheet=${config.apiSheet}&action=getData`;
            const response = await fetch(url);
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message);
            }
            
            const data = result.data;
            
            // 현재 데이터와 설정 저장
            this.currentData = data;
            this.currentConfig = config;
            
            // 데이터가 있으면 테이블 렌더링, 없으면 빈 상태 표시
            if (data && data.length > 0) {
                this.renderDataTable(data, config);
                this.showEmptyState(false);
            } else {
                this.showEmptyState(true);
            }
            
        } catch (error) {
            console.error('데이터 로드 실패:', error);
            this.showError(`데이터 로드 실패: ${error.message}`);
        } finally {
            this.showLoading(false);
        }
    }
    
    // 테이블 렌더링 (데스크톱)
    renderDataTable(data, config) {
        const tbody = document.getElementById('data-table-body');
        const thead = document.querySelector('.data-table thead tr');
        
        // 테이블 헤더 동적 생성
        thead.innerHTML = this.generateTableHeaderHTML(config);
        
        // 데이터 그룹핑 적용 (PSAC, RelaySchool에서만)
        let processedData = this.groupDataByDateAndBusinessNumber(data);
        
        // 데이터 정렬 적용
        processedData = this.sortData(processedData);
        
        // 현재 처리된 데이터 저장 (모달에서 사용)
        this.currentProcessedData = processedData;
        
        // 테이블 바디 초기화 및 데이터 렌더링
        tbody.innerHTML = '';
        
        processedData.forEach((item, index) => {
            const row = document.createElement('tr');
            
            // 그룹핑된 데이터인 경우 CSS 클래스 추가
            if (item.isGrouped && item.groupedEducation && item.groupedEducation.length > 1) {
                row.classList.add('grouped-row');
            }
            
            row.innerHTML = this.generateTableRowHTML(item, config);
            
            // 행 클릭 이벤트 (모달 열기 준비)
            row.addEventListener('click', (e) => {
                if (!e.target.matches('button, input[type="checkbox"]')) {
                    // 나중에 모달 열기 기능 추가
                }
            });
            
            tbody.appendChild(row);
        });
        
        // 체크박스 이벤트 설정
        this.setupCheckboxEvents();
    }

    // 테이블 헤더 HTML 생성
    generateTableHeaderHTML(config) {
        const pageType = new URLSearchParams(window.location.search).get('page');
        
        // 페이지 타입별로 다른 헤더 구조
        switch(pageType) {
            case '인허가':
            case '유자격':
                return `
                    <th class="col-checkbox"><input type="checkbox" id="select-all"></th>
                    <th>제목</th>
                    <th class="col-date">등록일</th>
                    <th class="col-status">상태</th>
                    <th class="col-actions">삭제</th>
                `;
            
            case '인사이드':
            case '아카데미':
                return `
                    <th class="col-checkbox"><input type="checkbox" id="select-all"></th>
                    <th>제목</th>
                    <th class="col-date">날짜</th>
                    <th class="col-status">상태</th>
                    <th class="col-actions">삭제</th>
                `;
                
            case 'PSAC':
            case 'RelaySchool':
                return `
                    <th class="col-checkbox"><input type="checkbox" id="select-all"></th>
                    <th class="col-number">순번</th>
                    <th>회사/기관</th>
                    <th>신청과목</th>
                    <th class="col-date">신청일시</th>
                    <th class="col-actions">삭제</th>
                `;
                
            case '고객문의':
                return `
                    <th class="col-checkbox"><input type="checkbox" id="select-all"></th>
                    <th class="col-id">ID</th>
                    <th>제목</th>
                    <th>문의자</th>
                    <th>이메일</th>
                    <th class="col-date">문의일</th>
                    <th class="col-status">처리상태</th>
                    <th class="col-actions">삭제</th>
                `;
                
            case '보도자료':
                return `
                    <th class="col-checkbox"><input type="checkbox" id="select-all"></th>
                    <th class="col-id">ID</th>
                    <th>제목</th>
                    <th>내용</th>
                    <th class="col-date">발행일</th>
                    <th class="col-status">상태</th>
                    <th class="col-actions">삭제</th>
                `;
                
            case '부패및윤리신고':
                return `
                    <th class="col-checkbox"><input type="checkbox" id="select-all"></th>
                    <th class="col-id">ID</th>
                    <th>제목</th>
                    <th>신고자</th>
                    <th class="col-date">신고일</th>
                    <th class="col-status">처리상태</th>
                    <th class="col-actions">삭제</th>
                `;
                
            default: // 팝업, 자주묻는질문 등
                return `
                    <th class="col-checkbox"><input type="checkbox" id="select-all"></th>
                    <th class="col-id">ID</th>
                    <th>제목</th>
                    <th>내용</th>
                    <th class="col-date">등록일</th>
                    <th class="col-status">상태</th>
                    <th class="col-actions">삭제</th>
                `;
        }
    }
    
    // 데이터 그룹핑 함수 (날짜와 사업자등록번호로 그룹핑)
    groupDataByDateAndBusinessNumber(data) {
        const pageType = new URLSearchParams(window.location.search).get('page');
        
        // PSAC, RelaySchool 페이지에서만 그룹핑 적용
        if (!['PSAC', 'RelaySchool'].includes(pageType)) {
            return data;
        }
        
        const grouped = {};
        const result = [];
        
        data.forEach(item => {
            // 날짜 추출 (applicationDate)
            const datetime = parseDatetime(item.applicationDate);
            const date = datetime.dateOnly;
            
            // 사업자등록번호 추출 (여러 필드명 지원)
            const businessNumber = item.businessNumber || item.companyRegistrationNumber || item.businessRegistrationNumber || '';
            
            // 그룹핑 키 생성 (날짜 + 사업자등록번호)
            // 사업자등록번호가 없으면 각각 별도 그룹으로 처리 (고유 ID 사용)
            let groupKey;
            if (businessNumber && businessNumber.trim() !== '') {
                groupKey = `${date}_${businessNumber.trim()}`;
            } else {
                // 사업자등록번호가 없으면 각 항목을 별도로 처리
                groupKey = `${date}_${item.number || item.id || Math.random()}`;
            }
            
            if (!grouped[groupKey]) {
                // 새 그룹 생성
                grouped[groupKey] = {
                    ...item, // 첫 번째 아이템의 기본 정보 사용
                    groupedEducation: [
                        item.studentName ? `(${item.studentName}) ${item.detailedEducation || ''}` : item.detailedEducation || ''
                    ], // 교육 내용들을 배열로 저장
                    groupedItems: [item], // 원본 아이템들 저장
                    isGrouped: true // 그룹핑된 데이터임을 표시
                };
            } else {
                // 기존 그룹에 추가
                const educationWithName = item.studentName ? `(${item.studentName}) ${item.detailedEducation || ''}` : item.detailedEducation || '';
                grouped[groupKey].groupedEducation.push(educationWithName);
                grouped[groupKey].groupedItems.push(item);
            }
        });
        
        // 그룹핑된 결과를 배열로 변환
        Object.values(grouped).forEach(group => {
            result.push(group);
        });
        
        return result;
    }

    // 데이터를 정렬하는 함수
    sortData(data) {
        const pageType = new URLSearchParams(window.location.search).get('page');
        
        // 페이지별로 정렬 기준 설정
        return data.sort((a, b) => {
            let dateA, dateB;
            
            switch(pageType) {
                case 'PSAC':
                case 'RelaySchool':
                    // 신청일 기준으로 정렬
                    dateA = new Date(a.applicationDate || '1970-01-01');
                    dateB = new Date(b.applicationDate || '1970-01-01');
                    break;
                    
                case '고객문의':
                    // 문의일 기준으로 정렬
                    dateA = new Date(a.submittedAt || '1970-01-01');
                    dateB = new Date(b.submittedAt || '1970-01-01');
                    break;
                    
                case '보도자료':
                    // 발행일 기준으로 정렬
                    dateA = new Date(a.publishDate || '1970-01-01');
                    dateB = new Date(b.publishDate || '1970-01-01');
                    break;
                    
                case '인허가':
                case '유자격':
                case '인사이드':
                case '아카데미':
                    // 등록일/날짜 기준으로 정렬
                    dateA = new Date(a.date || '1970-01-01');
                    dateB = new Date(b.date || '1970-01-01');
                    break;
                    
                default:
                    // 기본: ID 번호 기준으로 정렬
                    const idA = parseInt(a.id || a.number || 0);
                    const idB = parseInt(b.id || b.number || 0);
                    return this.isDescending ? idB - idA : idA - idB;
            }
            
            // 정렬 방향에 따라 결과 반환
            return this.isDescending ? dateB - dateA : dateA - dateB;
        });
    }
    
    // 정렬 토글 버튼 설정
    setupSortToggle() {
        const sortBtn = document.getElementById('btn-sort-toggle');
        const sortIcon = document.getElementById('sort-icon');
        
        if (!sortBtn) return;
        
        sortBtn.addEventListener('click', () => {
            // 정렬 방향 토글
            this.isDescending = !this.isDescending;
            
            // 버튼 UI 업데이트
            if (this.isDescending) {
                sortIcon.className = 'fas fa-sort-amount-down';
                sortBtn.innerHTML = '<i class="fas fa-sort-amount-down" id="sort-icon"></i> 최신순';
            } else {
                sortIcon.className = 'fas fa-sort-amount-up';
                sortBtn.innerHTML = '<i class="fas fa-sort-amount-up" id="sort-icon"></i> 오래된순';
            }
            
            // 데이터 다시 렌더링
            if (this.currentData && this.currentConfig) {
                this.renderDataTable(this.currentData, this.currentConfig);
            }
        });
    }
    
    // 삭제 버튼들 설정
    setupDeleteButtons() {
        const deleteSelectedBtn = document.getElementById('btn-delete-selected');
        
        if (!deleteSelectedBtn) return;
        
        deleteSelectedBtn.addEventListener('click', async () => {
            await this.deleteSelectedItems();
        });
    }
    
    // 선택된 항목들 삭제
    async deleteSelectedItems() {
        const checkedBoxes = document.querySelectorAll('input[type="checkbox"][data-id]:checked');
        const ids = Array.from(checkedBoxes).map(cb => cb.getAttribute('data-id'));
        
        if (ids.length === 0) {
            alert('삭제할 항목을 선택해주세요.');
            return;
        }
        
        if (!confirm(`선택한 ${ids.length}개 항목을 정말로 삭제하시겠습니까?`)) {
            return; // 사용자가 취소를 선택한 경우
        }
        
        try {
            // 배치 삭제 API 호출
            const response = await fetch(this.appsScriptUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'batchDelete',
                    sheet: this.currentConfig.apiSheet,
                    ids: ids
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // 성공: 페이지 새로고침
                location.reload();
            } else {
                // 실패: 오류 메시지 표시
                alert(`오류: 삭제에 실패했습니다. (${result.message})`);
            }
            
        } catch (error) {
            console.error('선택 삭제 오류:', error);
            alert('오류: 삭제에 실패했습니다.');
        }
    }

    // 테이블 행 HTML 생성
    generateTableRowHTML(item, config) {
        const pageType = new URLSearchParams(window.location.search).get('page');
        
        // 페이지 타입별로 다른 컬럼 구조
        switch(pageType) {
            case '인허가':
            case '유자격':
                return `
                    <td class="col-checkbox"><input type="checkbox" data-id="${item.id}"></td>
                    <td>${item.titleKR || '제목 없음'}</td>
                    <td class="col-date">${item.date || '-'}</td>
                    <td class="col-status"><span class="status-badge ${item.state === 'on' ? 'status-active' : 'status-inactive'}">${item.state === 'on' ? 'ON' : 'OFF'}</span></td>
                    <td class="col-actions">
                        <button class="btn btn-danger btn-sm" onclick="deleteItem('${item.id}')"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                `;
            
            case '인사이드':
            case '아카데미':
                return `
                    <td class="col-checkbox"><input type="checkbox" data-id="${item.id}"></td>
                    <td>${item.titleKR || '제목 없음'}</td>
                    <td class="col-date">${item.date || ''}</td>
                    <td class="col-status"><span class="status-badge ${item.state === 'on' ? 'status-active' : 'status-inactive'}">${item.state === 'on' ? 'ON' : 'OFF'}</span></td>
                    <td class="col-actions">
                        <button class="btn btn-danger btn-sm" onclick="deleteItem('${item.id}')"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                `;
                
            case 'PSAC':
            case 'RelaySchool':
                const datetime = parseDatetime(item.applicationDate);
                
                // 디버깅용 로그 추가
                // if (pageType === 'PSAC') {
                //     console.log('PSAC 디버깅:', {
                //         원본데이터: item,
                //         applicationDate: item.applicationDate,
                //         파싱결과: datetime
                //     });
                // }
                
                // 그룹핑된 데이터인지 확인
                if (item.isGrouped && item.groupedEducation && item.groupedEducation.length > 1) {
                    // 그룹핑된 여러 교육 내용을 표시
                    const educationList = item.groupedEducation
                        .filter(edu => edu && edu.trim()) // 빈 값 제거
                        .map((edu, index) => `<span class="group-item">${edu.trim()}</span>`)
                        .join('');
                        
                    return `
                        <td class="col-checkbox"><input type="checkbox" data-id="${item.number}"></td>
                        <td>${item.number}</td>
                        <td>${item.companyName || '-'}</td>
                        <td class="grouped-cell">
                            <div class="group-header">
                                <i class="fas fa-layer-group group-icon"></i>
                                그룹 (${item.groupedEducation.length}명)
                            </div>
                            ${educationList}
                        </td>
                        <td class="col-date">
                            <div>${datetime.dateOnly}</div>
                            ${datetime.timeOnly !== '-' ? `<small style="color: #666;">${datetime.timeOnly}</small>` : ''}
                        </td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="showGroupDeleteModal('${item.number}')"><i class="fa-solid fa-trash-can"></i></button>
                        </td>
                    `;
                } else {
                    // 단일 데이터
                    const educationWithName = item.studentName ? `(${item.studentName}) ${item.detailedEducation || ''}` : item.detailedEducation || '';
                    return `
                        <td class="col-checkbox"><input type="checkbox" data-id="${item.number}"></td>
                        <td>${item.number}</td>
                        <td>${item.companyName || '-'}</td>
                        <td>${educationWithName}</td>
                        <td class="col-date">
                            <div>${datetime.dateOnly}</div>
                            ${datetime.timeOnly !== '-' ? `<small style="color: #666;">${datetime.timeOnly}</small>` : ''}
                        </td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteItem('${item.number}')"><i class="fa-solid fa-trash-can"></i></button>
                        </td>
                    `;
                }
            case '고객문의':
                const inquiryDatetime = parseDatetime(item.submittedAt);
                return `
                    <td class="col-checkbox"><input type="checkbox" data-id="${item.submissionId}"></td>
                    <td>${item.submissionId}</td>
                    <td>${item.subject || '제목 없음'}</td>
                    <td>${item.nameCompany || '-'}</td>
                    <td>${item.emailPhone || '-'}</td>
                    <td>
                        <div>${inquiryDatetime.dateOnly}</div>
                        <small style="color: #666;">${inquiryDatetime.timeOnly}</small>
                    </td>
                    <td><span class="status-badge status-pending">접수</span></td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteItem('${item.submissionId}')"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                `;
                
            case '보도자료':
                return `
                    <td class="col-checkbox"><input type="checkbox" data-id="${item.id}"></td>
                    <td>${item.id}</td>
                    <td>${item.title || '제목 없음'}</td>
                    <td>${item.content ? (item.content.length > 30 ? item.content.substring(0, 30) + '...' : item.content) : '내용 없음'}</td>
                    <td>${item.publishDate || '-'}</td>
                    <td><span class="status-badge status-active">게시중</span></td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteItem('${item.id}')"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                `;
                
            case '부패및윤리신고':
                return `
                    <td class="col-checkbox"><input type="checkbox" data-id="${item.id}"></td>
                    <td>${item.id}</td>
                    <td>${item.subject || '제목 없음'}</td>
                    <td>${item.reporterName || '익명'}</td>
                    <td>${item.reportDate || '-'}</td>
                    <td><span class="status-badge ${item.status === '완료' ? 'status-active' : 'status-pending'}">${item.status || '접수'}</span></td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteItem('${item.id}')"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                `;
                
            default: // 팝업, 자주묻는질문 등
                return `
                    <td class="col-checkbox"><input type="checkbox" data-id="${item.id}"></td>
                    <td>${item.id}</td>
                    <td>${item.title || item.subject || '제목 없음'}</td>
                    <td>${item.content ? (item.content.length > 30 ? item.content.substring(0, 30) + '...' : item.content) : '내용 없음'}</td>
                    <td class="col-date">${item.date || item.createdDate || '-'}</td>
                    <td><span class="status-badge status-active">활성</span></td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteItem('${item.id}')"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                `;
        }
    }
    
    // 체크박스 이벤트 설정
    setupCheckboxEvents() {
        const selectAll = document.getElementById('select-all');
        const checkboxes = document.querySelectorAll('input[type="checkbox"][data-id]');
        const deleteBtn = document.getElementById('btn-delete-selected');
        
        // 전체 선택 체크박스
        selectAll.addEventListener('change', (e) => {
            checkboxes.forEach(cb => cb.checked = e.target.checked);
            this.updateDeleteButton();
        });
        
        // 개별 체크박스
        checkboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                this.updateDeleteButton();
            });
        });
    }
    
    // 삭제 버튼 상태 업데이트
    updateDeleteButton() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"][data-id]:checked');
        const deleteBtn = document.getElementById('btn-delete-selected');
        
        if (checkboxes.length > 0) {
            deleteBtn.disabled = false;
            deleteBtn.textContent = `선택 삭제 (${checkboxes.length})`;
        } else {
            deleteBtn.disabled = true;
            deleteBtn.textContent = '선택 삭제';
        }
    }
    
    // 로딩 상태 표시
    showLoading(show) {
        const loading = document.getElementById('loading-indicator');
        const tableContainer = document.querySelector('.data-table-container');
        
        if (show) {
            loading.style.display = 'block';
            tableContainer.style.display = 'none';
        } else {
            loading.style.display = 'none';
            tableContainer.style.display = 'block';
        }
    }
    
    // 빈 상태 표시
    showEmptyState(show) {
        const emptyState = document.getElementById('empty-state');
        const tableContainer = document.querySelector('.data-table-container');
        
        if (show) {
            emptyState.style.display = 'block';
            tableContainer.style.display = 'none';
        } else {
            emptyState.style.display = 'none';
        }
    }
}

// 전역 함수들 (버튼 onclick에서 사용)
async function deleteItem(id) {
    if (!confirm('정말로 이 항목을 삭제하시겠습니까?')) {
        return; // 사용자가 취소를 선택한 경우
    }
    
    try {
        // 현재 페이지 정보 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        const pageParam = urlParams.get('page');
        
        // PageManager 인스턴스에서 설정 정보 가져오기
        const pageManager = window.pageManagerInstance; // 전역 변수로 저장된 인스턴스
        if (!pageManager || !pageManager.pageConfigs[pageParam]) {
            alert('오류: 페이지 설정을 찾을 수 없습니다.');
            return;
        }
        
        const config = pageManager.pageConfigs[pageParam];
        const appsScriptUrl = pageManager.appsScriptUrl;
        
        // 삭제 API 호출 (GET 방식으로 변경 - CORS 문제 해결)
        const deleteUrl = `${appsScriptUrl}?action=delete&sheet=${config.apiSheet}&id=${encodeURIComponent(id)}`;
        const response = await fetch(deleteUrl, {
            method: 'GET'
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 성공: 페이지 새로고침
            location.reload();
        } else {
            // 실패: 오류 메시지 표시
            alert(`오류: 삭제에 실패했습니다. (${result.message})`);
        }
        
    } catch (error) {
        console.error('삭제 오류:', error);
        alert('오류: 삭제에 실패했습니다.');
    }
}

// 그룹 삭제 모달 관련 변수
let currentGroupData = null;

// 그룹 삭제 모달 열기
function showGroupDeleteModal(representativeId) {
    const pageManager = window.pageManagerInstance;
    if (!pageManager) {
        alert('오류: 페이지 매니저를 찾을 수 없습니다.');
        return;
    }
    
    // 현재 페이지의 모든 데이터에서 해당 그룹 찾기
    const processedData = pageManager.currentProcessedData || [];
    
    const targetGroup = processedData.find(group => {
        // 타입 변환을 통한 안전한 비교
        const groupNumber = String(group.number);
        const targetId = String(representativeId);
        
        const matchByNumber = groupNumber === targetId;
        const matchByGroupedItems = group.groupedItems && group.groupedItems.some(item => {
            const itemId = String(item.number || item.id);
            return itemId === targetId;
        });
        
        return matchByNumber || matchByGroupedItems;
    });
    
    if (!targetGroup || !targetGroup.groupedItems) {
        alert('오류: 그룹 정보를 찾을 수 없습니다.');
        return;
    }
    
    currentGroupData = targetGroup;
    
    // 모달 리스트 생성
    const groupDeleteList = document.getElementById('groupDeleteList');
    groupDeleteList.innerHTML = '';
    
    targetGroup.groupedItems.forEach((item, index) => {
        const educationText = item.studentName ? 
            `(${item.studentName}) ${item.detailedEducation || ''}` : 
            item.detailedEducation || '';
            
        const listItem = document.createElement('li');
        listItem.className = 'group-delete-item';
        listItem.innerHTML = `
            <input type="checkbox" id="groupItem_${index}" data-id="${item.number || item.id}" data-index="${index}">
            <label for="groupItem_${index}" class="group-delete-item-content">
                ${educationText}
                <small style="color: #666; display: block; margin-top: 2px;">
                    신청번호: ${item.number || item.id} | 회사: ${item.companyName || '-'}
                </small>
            </label>
        `;
        
        groupDeleteList.appendChild(listItem);
    });
    
    // 전체 선택 체크박스 이벤트 설정
    setupSelectAllEvent();
    
    // 모달 표시
    document.getElementById('groupDeleteModal').style.display = 'block';
}

// 그룹 삭제 모달 닫기
function closeGroupDeleteModal() {
    document.getElementById('groupDeleteModal').style.display = 'none';
    currentGroupData = null;
    
    // 체크박스 초기화
    const checkboxes = document.querySelectorAll('#groupDeleteList input[type="checkbox"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);
    document.getElementById('selectAllGroupItems').checked = false;
}

// 전체 선택 체크박스 이벤트 설정
function setupSelectAllEvent() {
    const selectAllCheckbox = document.getElementById('selectAllGroupItems');
    const itemCheckboxes = document.querySelectorAll('#groupDeleteList input[type="checkbox"]');
    
    selectAllCheckbox.addEventListener('change', function() {
        itemCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });
    
    // 개별 체크박스 이벤트
    itemCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const checkedCount = document.querySelectorAll('#groupDeleteList input[type="checkbox"]:checked').length;
            const totalCount = itemCheckboxes.length;
            
            selectAllCheckbox.checked = checkedCount === totalCount;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < totalCount;
        });
    });
}

// 선택된 그룹 항목들 삭제
async function deleteSelectedGroupItems() {
    const checkedBoxes = document.querySelectorAll('#groupDeleteList input[type="checkbox"]:checked');
    
    if (checkedBoxes.length === 0) {
        alert('삭제할 항목을 선택해주세요.');
        return;
    }
    
    if (!confirm(`선택한 ${checkedBoxes.length}개 항목을 삭제하시겠습니까?\n⚠️ 이 작업은 되돌릴 수 없습니다.`)) {
        return;
    }
    
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const pageParam = urlParams.get('page');
        const pageManager = window.pageManagerInstance;
        
        if (!pageManager || !pageManager.pageConfigs[pageParam]) {
            alert('오류: 페이지 설정을 찾을 수 없습니다.');
            return;
        }
        
        const config = pageManager.pageConfigs[pageParam];
        const appsScriptUrl = pageManager.appsScriptUrl;
        
        // 선택된 아이템들의 ID 수집
        const idsToDelete = Array.from(checkedBoxes).map(checkbox => checkbox.dataset.id);
        
        // 배치 삭제 요청
        const batchDeleteUrl = `${appsScriptUrl}?action=batchDelete&sheet=${config.apiSheet}&ids=${encodeURIComponent(JSON.stringify(idsToDelete))}`;
        
        const response = await fetch(batchDeleteUrl, {
            method: 'GET'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`${idsToDelete.length}개 항목이 삭제되었습니다.`);
            closeGroupDeleteModal();
            location.reload();
        } else {
            alert(`오류: 삭제에 실패했습니다. (${result.message})`);
        }
        
    } catch (error) {
        console.error('선택 삭제 오류:', error);
        alert('오류: 삭제에 실패했습니다.');
    }
}

// 모달 외부 클릭 시 닫기
window.addEventListener('click', function(event) {
    const modal = document.getElementById('groupDeleteModal');
    if (event.target === modal) {
        closeGroupDeleteModal();
    }
});

</script>